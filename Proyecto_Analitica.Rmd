---
title: "Proyecto Final"
author: "PAULA ADJEMIAN, GERMAN ADJEMIAN Y RAFAEL TRUJILLO - Analitica de Datos "
date: "18/ 11/ 2025"
output: 
  html_document:
    theme: journal
    toc: true
    toc_float: true
    collapsed: true
    smooth_scroll: true
    highlight: kate
    code_folding: show
    
---

# Proyecto Final 2 Semestre 2025

La base de datos PrestamosUY.xlsx recopila información proveniente de una empresa financiera uruguaya. Contiene registros correspondientes a una muestra de préstamos personales otorgados por dicha institución. Para cada préstamo se relevaron diversas variables cuantitativas y cualitativas vinculadas a las características del cliente, las condiciones del crédito y el comportamiento de pago: 

  • ID. Identificador del titular del préstamo. 
  • Ingreso. Ingreso anual (dólares) del titular del préstamo. 
  • Disponible. Línea de crédito disponible (dólares) luego de efectuado el préstamo. 
  • Importe. Importe en dólares del préstamo personal otorgado. 
  • Sexo. Sexo del titular: 1-Hombre y 2-Mujer. 
  • Educacion. Máximo nivel de estudios del titular: 1-Universidad, 2-Secundaria, 3 Primaria, 4-Otra.  
  • Estado_Civil. Estado civil del titular: 1-Casado/Unión libre,  2 Soltero/Divorciado/Viudo. 
  • Edad: Edad en años del titular al momento de sacar el préstamo.   
  • Default: Incumplimiento de pagos (default): 1-Default y 0-No default. 

Esta base de datos será empleada para el desarrollo de modelos de machine learning de regresión lineal y clasificación, con el objetivo de identificar los factores que determinan el monto de los préstamos y estimar la probabilidad de incumplimiento de pago por parte de los clientes. 

```{r}
library(readxl)
datos = read_excel("PrestamosUY.xlsx")
```


## PARTE 1: Realizar un análisis descriptivo de las variables a utilizar: Interpretar los vínculos entre ellas y las características de cada una.  
• Implementar gráficos que relacionen la variable a predecir con cada una de 
las variables de la base (Gráficos de dispersión de la variable dependiente 
contra las otras variables cuantitativas y gráficos de caja que relacionen la 
variable a predecir con las cualitativas. Comentar las gráficas obtenidas. 
• Análisis de correlación de las variables cuantitativas. Reportar y comentar la 
matriz de correlación.  
• Reportar al menos una tabla de frecuencias absolutas y relativas para 
alguna de las variables cualitativas de la base. 
• Realizar una prueba de hipótesis para determinar si el ingreso anual de los 
clientes difiere significativamente de los USD 30000 anuales. Utilizar un 
nivel de significación del 5%  

```{r}
round(cor(datos[,-1]),2)#El ID no aporta
print("")
cov(datos["Ingreso"], datos["Importe"])
cov(datos["Disponible"], datos["Importe"])
```

En primera instancia se observa una correlación positiva de 0.83 entre el
importe y los ingresos anuales del titular del prestamo, lo cual indica una 
asociación fuerte y directa entre los ingresos del usuario y el prestamo que
le es otorgado al mismo, es decir, que cuanto mayor el salario de una persona,
más probable es que le den un prestamo mayor.

Otra variable que se destaca por su correlación con importe es la variable 
"disponible", en este caso con un valor negativo de -0.70, indicando una
asociación fuerte e indirecta entre la  de crédito disponible luego de efectuado
el préstamo con el importe otorgado en el mismo.

Hay correlación positiva débil con edad (0.15)), lo cual indica que personas
ligeramente mayores tienden a recibir montos apenas superiores.

Las otras variables no se comentan porque son cualitativas.

```{r}
par(mfrow = c(1,3))

#Gráficos para cuantitativas
plot(datos$Ingreso, datos$Importe, main = "Importe en funcion de Ingresos Anuales" ,sub = "Elaboración Propia", col = "red")
abline(lm(datos$Importe ~ datos$Ingreso), col = "blue", lwd = 2)

plot(datos$Disponible, datos$Importe, main = "Importe en funcion Disponible" ,sub = "Elaboración Propia", col = "red")
abline(lm(datos$Importe ~ datos$Disponible), col = "blue", lwd = 2)

plot(datos$Edad, datos$Importe, main = "Importe en funcion de Edad del usuario" ,sub = "Elaboración Propia", col = "red")
abline(lm(datos$Importe ~ datos$Edad), col = "blue", lwd = 2)
```

###Importe en función de Ingresos:
En la primera gráfica se observa una clara tendencia creciente: a medida que
aumentan los ingresos anuales de los individuos, también aumenta el importe del 
préstamo otorgado. Esta relación positiva coincide con lo observado previamente 
en la matriz de correlación, donde la asociación entre ambas variables es
fuerte (r = 0.83).
El patrón ascendente sugiere que el nivel de ingresos es un determinante
importante del monto aprobado, lo cual es coherente con las políticas usuales
de crédito: los usuarios con mayor capacidad económica tienden a acceder a
préstamos más elevados, ya sea por un mayor poder de pago o por una mayor 
calificación crediticia.


###Importe en función de línea de crédito disponible:
En la segunda gráfica podemos observar justamente lo contrario que en la primera, 
una clara tendencia decreciente: a medida que el monto “Disponible” aumenta, el 
importe del préstamo disminuye. La nube de puntos cae hacia la derecha: valores 
altos de Disponible se asocian con importes bajos, y valores bajos de Disponible
se asocian con importes altos.
Esto es completamente lógico, si a una persona le otorgaron un préstamo grande, 
entonces después del préstamo le queda muy poco disponible; en cambio, si le
dieron un préstamo chico, le debería quedar más crédito libre.


###Importe en función de edad: 
En la tercera gráfica, se ve que mientras la edad del titular aumenta, el importe
del préstamo tiende a subir levemente, pero la relación es muy débil. La nube de
puntos está bastante dispersa y no muestra un patrón tan claro como en los
gráficos de Importe en funciòn de Ingreso o Importe en función de Disponible.
Por último la línea azul tiene una pendiente ligeramente positiva, lo que indica 
que, en promedio, las personas de mayor edad tienden a recibir importes
ligeramente más altos, pero la diferencia no es grande y hay mucha variabilidad.

```{r}
par(mfrow = c(1,3))
boxplot(datos$Importe ~ datos$Sexo, main = "Importe en función de sexo", col = "red")
boxplot(datos$Importe ~ datos$Educacion, main = "Importe en función de nivel de nivel de educaciòn", col = "red")
boxplot(datos$Importe ~ datos$Estado_Civil, main = "Importe en función de estado civil", col = "red")
```
###Importe en función de sexo:
En este gráfico se comparan los importes otorgados entre hombres (1) y mujeres (2).
Los dos grupos muestran distribuciones muy parecidas: las medianas son casi 
iguales y la dispersión también. No parece haber una diferencia importante entre 
sexos en el monto de los préstamos. En resumen, el sexo del titular no influye
demasiado en el importe otorgado.

###Importe en función del nivel de educación:
Acá si se ve un patrón más marcado; las personas con educación universitaria 
(categoría 1) reciben, en promedio, los montos más altos. A medida que el nivel 
educativo baja (2 = secundaria, 3 = primaria, 4 = otra), el importe otorgado 
también tiende a disminuir.
La mediana baja claramente de la categoría 1 a la 3, y la categoría 4 queda más 
o menos en el medio; dicho de otra manera: a mayor nivel educativo, mayor
importe del préstamo.

###Importe en función de estado civil:
El gráfico compara Casado/Unión libre (1) contra Soltero/Divorciado/Viudo (2).
Las dos categorías son bastante parecidas, pero se observa que quienes están en 
la categoría 1 tienen una mediana ligeramente más alta, aunque la diferencia no 
es muy grande. 
La dispersión de ambos grupos también es similar.
Dicho de forma sencilla: las personas casadas o en unión estable tienden a 
recibir montos un poco más altos, pero la diferencia no es muy marcada.

##Tabla de frecuencias para el SEXO de los clientes 
```{r}
frec.absoluta = table(datos$Sexo)
frec.relativa = prop.table(frec.absoluta)

tabla = cbind(frec.absoluta, frec.relativa)
colnames(tabla) = c("Frecuencia Absoluta", "Frecunecia Relativa")
rownames(tabla) = c("Hombre", "Mujer")
tabla
```
##Realizar una prueba de hipótesis para determinar si el ingreso anual de los clientes difiere significativamente de los USD 30000 anuales. Utilizar un nivel de significación del 5%

H0: promedio ingresos anuales cliente (mu) = $30000 USD para una significaciòn del 5%
H1: promedio ingresos anuales cliente (mu) != $30000 USD para una significación del 5%

```{r}
t.test(datos$Ingreso, mu = 30000, conf.level = 0.95)
```
Respuesta: t= 8.624, p-value = 2,2e-16, mu = 30930.42

Interpretación: para el promedio ingresos anuales cliente con mu = 30930, se alejo 8.624 desvios estandar por arriba del valor hipotético mu = 30000.
Dado que t-value es mayor a 2 y p-value menor al 5%, se decide rechazar h0 y aceptar h1.
Basado en la muestra de 16444 clientes, podemos concluir que para un nivel de significación del 5% el promedio poblacional de los ingreso anuales del cliente, difiere significativamente de los $30000 USD.

#PARTE 1.2 Estimar regresiones lineales e interpretar los resultados: 

## A) Entrenar al modelo con el 60% de los datos (train) y valídarlo con el restante 40% (test). Utilizar la CI de un integrante del grupo como semilla aleatoria.

```{r}
set.seed(54039598)
train = sample(nrow(datos),nrow(datos)*0.60) 
test  =(-train)
```

## B) Estimar una primera regresión con todas las variables a utilizar. Indicar el método de estimación utilizado, interpretar cuáles son significativas y cuáles no (escribir las pruebas de hipótesis, estadísticos de prueba utilizados, los valores p, las decisiones y  conclusiones.  

```{r}
datos$Sexo_dummy <- as.factor(datos$Sexo)
datos$Educacion_dummy <- as.factor(datos$Educacion)
datos$Estado_Civil_dummy <- as.factor(datos$Estado_Civil)
```


```{r}
Modelo = lm(Importe ~ Ingreso + Default + Disponible + Edad + Sexo_dummy + Educacion_dummy + Estado_Civil_dummy, data = datos[train,])

summary(Modelo)
```

Para evaluar la significación de cada variable emplearemos el estadístico t y el p-valor.
Si el valor-p es menor al 5% y el estadístico t es mayor a 2 desviaciones estándares, se rechaza la hipótesis nula y la variable se considera significativa.En caso contrario, optaremos por no rechazar la hipótesis nula.

### Ingreso
Ho = El ingreso no tiene impacto significativo sobre el importe.
H1 = El ingreso tiene impacto significativo sobre el importe.

|t| = 350.938 > 2
p-valor = 0.0000000000000002 < 0.05 

Decisión:
Decidimos, basados en el estadístico t y el p-valor, rechazar la hipótesis nula y aceptar la hipótesis alternativa.

Conclusión:
Basándonos en una muestra de entrenamiento de 9866 clientes, podemos concluir con un nivel de significación del 5% que la variable ingreso tiene efecto significativo sobre el importe.

### Default
Ho = El default no tiene impacto significativo sobre el importe.
H1 = El default tiene impacto significativo sobre el importe.

|t| = 64.087 > 2
p-valor = 0.0000000000000002 < 0.05 

Decisión:
Decidimos, basados en el estadístico t y el p-valor, rechazar la hipótesis nula y aceptar la hipótesis alternativa.

Conclusión:
Basándonos en una muestra de entrenamiento de 9866 clientes, podemos concluir con un nivel de significación del 5% que la variable default tiene efecto significativo sobre el importe.

### Disponible
Ho = La disponibilidad no tiene impacto significativo sobre el importe.
H1 = La disponibilidad tiene impacto significativo sobre el importe.

|t| = |-280.954| > 2
p-valor = 0.0000000000000002 < 0.05 

Decisión:
Decidimos, basados en el estadístico t y el p-valor, rechazar la hipótesis nula y aceptar la hipótesis alternativa.

Conclusión:
Basándonos en una muestra de entrenamiento de 9866 clientes, podemos concluir con un nivel de significación del 5% que la variable disponibilidad tiene efecto significativo sobre el importe.

### Edad
Ho = La edad no tiene impacto significativo sobre el importe.
H1 = La edad tiene impacto significativo sobre el importe.

|t| = |4.436| > 2
p-valor = 0.00000000924 < 0.05 

Decisión:
Decidimos, basados en el estadístico t y el p-valor, rechazar la hipótesis nula y aceptar la hipótesis alternativa.

Conclusión:
Basándonos en una muestra de entrenamiento de 9866 clientes, podemos concluir con un nivel de significación del 5% que la variable edad tiene efecto significativo sobre el importe.

### Sexo_dummy2
Ho = El sexo no tiene impacto significativo sobre el importe.
H1 = El sexo tiene impacto significativo sobre el importe.

|t| = |1.641| < 2
p-valor = 0.10075 > 0.05 

Decisión:
Decidimos, basados en el estadístico t y el p-valor, no rechazar la hipótesis nula.

Conclusión:
Basándonos en una muestra de entrenamiento de 9866 clientes, podemos concluir con un nivel de significación del 5% que la variable sexo no tiene efecto significativo sobre el importe.

### Educacion_dummy2
Ho = El segundo nivel de educación (secundaria) no tiene impacto significativo sobre el importe.
H1 = El segundo nivel de educación (secundaria) tiene impacto significativo sobre el importe.

|t| = |-8.393| > 2
p-valor = 0.0000000000000002 < 0.05 

Decisión:
Decidimos, basados en el estadístico t y el p-valor, rechazar la hipótesis nula y aceptar la hipótesis alternativa.

Conclusión:
Basándonos en una muestra de entrenamiento de 9866 clientes, podemos concluir con un nivel de significación del 5% que El segundo nivel de educación (secundaria) tiene efecto significativo sobre el importe.

### Educacion_dummy3
Ho = El tercer nivel de educación (primaria) no tiene impacto significativo sobre el importe.
H1 = El tercer nivel de educación (primaria) tiene impacto significativo sobre el importe.

|t| = |-3.461| > 2
p-valor = 0.00054 < 0.05 

Decisión:
Decidimos, basados en el estadístico t y el p-valor, rechazar la hipótesis nula y aceptar la hipótesis alternativa.

Conclusión:
Basándonos en una muestra de entrenamiento de 9866 clientes, podemos concluir con un nivel de significación del 5% que El tercer nivel de educación (primaria) tiene efecto significativo sobre el importe.

### Educacion_dummy4
Ho = El cuarto nivel de educación (otro) no tiene impacto significativo sobre el importe.
H1 = El cuarto nivel de educación (otro) tiene impacto significativo sobre el importe.

|t| = |-1.355| < 2
p-valor = 0.17554 > 0.05 

Decisión:
Decidimos, basados en el estadístico t y el p-valor, no rechazar la hipótesis nula.

Conclusión:
Basándonos en una muestra de entrenamiento de 9866 clientes, podemos concluir con un nivel de significación del 5% que El cuarto nivel de educación (otro) no tiene efecto significativo sobre el importe.

### Estado_civil_dummy2
Ho = El estado civil no tiene impacto significativo sobre el importe.
H1 = El estado civil tiene impacto significativo sobre el importe.

|t| = |-0.777| < 2
p-valor = 0.43690 > 0.05 

Decisión:
Decidimos, basados en el estadístico t y el p-valor, no rechazar la hipótesis nula.

Conclusión:
Basándonos en una muestra de entrenamiento de 9866 clientes, podemos concluir con un nivel de significación del 5% que estado civil no tiene efecto significativo sobre el importe.

## C) Aplicar un método automático de selección de variables e interpretar los resultados.  

```{r}
library(olsrr)
Modelo_BOTH= ols_step_both_p(Modelo, penter=0.05)
Modelo_BOTH
```

```{r}
Modelo_Reducido = lm(Importe ~ Ingreso + Disponible + Default + Educacion_dummy + Edad  + Sexo_dummy, data = datos[train,])

summary(Modelo_Reducido)
```

```{r}
Modelo_Reducido2 = lm(Importe ~ Ingreso + Disponible + Default + Educacion_dummy + Edad, data = datos[train,])

summary(Modelo_Reducido2)
```

## D) Analizar si existe multicolinealidad, abordarla de ser necesario. 

```{r}
car::vif(Modelo_Reducido2)
```

Ninguna variable tiene un valor VIF mayor a cinco, por ende, no hay multicolinealidad entre las variables empleadas en el modelo.

## E) Interpretar la bondad de ajuste del modelo 
Bondad de ajuste
R2 ajustado = 0.9688 El 96,88% de la variación en el Importe de los préstamos se explica por la variación en las variables incluidas en el modelo (Ingreso, Default, Disponible, Edad, Nivel educativo), considerando además el tamaño de la muestra y la cantidad de predictores utilizados.

## F) Verificar si existe sobreajuste (train vs test)
```{r}
datos$pred_importe = predict(Modelo_Reducido2, datos)

RCME.train <- sqrt (mean ((datos$Importe[train] - datos$pred_importe[train])**2 ) )
RCME.train

RCME.test <- sqrt (mean ((datos$Importe[test] - datos$pred_importe[test])**2 ) )
RCME.test
#Sobreajuste?
RCME.test/RCME.train >2 
```

El error promedio de predicción del balance cometido por el modelo en la base de entrenamiento es es de aproximadamente 2591.306, mientras que en la base de testing es de 2526.92.

##G) Reportar la ecuación del modelo final e interpretar los coeficientes de la misma en el contexto del problema. 

Modelo final: Importe = 39260 + 0.8069 \* Ingreso - 0.5817 \* Disponible + 5624 \* Default -496.6 \* Educacion_dummy2 - 569.2 \* Educacion_dummy3 - 680.2 \* Educacion_dummy4 + 17.40 \* Edad

### Intercepto
Representa el importe promedio cuando todas las variables se igualan a 0. No tiene sentido en la vida real.

### Ingreso
En promedio, por cada dolar más en el ingreso anual del titular del prestamo, el importe aumenta 0.8069 dólares. Manteniendo el resto de las variables constantes.

### Disponible
En promedio, por cada dolar más en la línea de crédito luego de efectuado el préstamo., el importe aumenta 0.5817 dólares.Manteniendo el resto de las variables constantes.
### Edad
En promedio, por cada año más del titular del préstamo, el importe aumenta 17.40 dólares.Manteniendo el resto de las variables constantes.
### Default
En promedio, el incumplimiento de pagos decrementa el importe 496.6 dólares. Manteniendo el resto de las variables constantes.
### Educacion_dummy2
En promedio, las personas que tienen un nivel educativo secundario decrementa en 496.6 dólares.Manteniendo el resto de las variables constantes.
### Educacion_dummy3
En promedio, las personas que tienen un nivel educativo primario decrementa en 569.2 dólares.Manteniendo el resto de las variables constantes.
### Educacion_dummy4
En promedio, las personas que tener otros niveles de educación decrementa en 680.2 dólares.Manteniendo el resto de las variables constantes.

##Parte 1.3

```{r}
Importe = 39260 + 0.8069 * 45000 - 0.5817 * 12000 + 5624 * 0 -496.6 * 1 - 569.2 * 0 - 680.2 * 0 + 17.40 * 29
Importe
```

## Parte 2: Elaborar un modelo de árbol de clasificación que sirva para predecir cuándo hay un incumplimiento de pagos (Default). 

```{r}
library(tree)
library(rio) 
library(rpart)
library(rattle)

set.seed(54039598)   
train <- sample(nrow(datos), nrow(datos)*0.6) 
test <- (-train)

par(mfrow = c(1, 1))
Arbol1 = rpart(Default ~ Ingreso + Disponible + Importe + Edad + Sexo + Educacion + Estado_Civil,
               datos[train,], method = 'class')

Arbol1

fancyRpartPlot(Arbol1)

plotcp(Arbol1)

```
```{r}
Arbol2 = prune(Arbol1, cp = 0.03)
fancyRpartPlot(Arbol2)

```
El nodo raíz y este es el 100% de los datos de TRAIN. 
    El 0.82 es la proporción del nodo en NO DEFAULT y el restante 0.18 es la proporción de SI DEFAULT
    Además nos muestra la moda del nodo y este es NO DEFAULT.
Reglas de decisión:
  
  PRIMERA REGLA:  
    En el caso de que este importe sea < 16000
      El 10% de los datos de TRAIN esta en el NODO 3, lo cual predice SI DEFAULT. Con una proporción de SI DEFAULT de 100% y 0% en NO DEFAULT.
      
  SEGUNDA REGLA:
    Mientras que en el caso del ingreso anual del titular sea < 15000 y el importe del prestamos >= 16000.
    El 1% de los datos de TRAIN esta en el NODO TERMINAL 5, predice SI DEFAULT y con una proporción de 100% SI DEFAULT.
  
  TERCERA REGLA       
    En el caso de que el ingreso anual del titular sea >= 15000 y el importe del prestamo >= 16000
    El 88% de los datos de TRAIN esta en el NODO 4, predice NO DEFAULT y con una proporción de NO DEFAULT de 93% mientras que SI DEFAULT 7%.

  
```{r}
asRules(Arbol2)
```

```{r}
datos$prediccion_default = predict(Arbol2, datos)[, 2]
datos
```

###Analizar la bondad de ajuste mediante la matriz de confusión y las métricas derivadas de las mismas.  Verificar si existe sobreajuste (train vs test). 

### Matriz de Confusion en la base de TRAINING.  
Probabilidad > 0,5 como punto de corte. Le damos el punto de corte para que haga la predicción, en base a la probabilidad que predice.
```{r}
tabla_confusion_train = addmargins(table(datos$Default[train],datos$prediccion_default[train] > 0.5))
rownames(tabla_confusion_train) = c("Default NO" ,"Default SI", "TOTAL" )
colnames(tabla_confusion_train)= c("Prediccion Default NO" ,"  Prediccion Default SI" ,"TOTAL" )
tabla_confusion_train
```
### Metricas de la bondad de las predicciones:
Precision
```{r}
(1182+8100)/9866
```
Se observa que el 94% de las predicciones de default son clasificadas correctamente respecto al total de clientes testeados.

Tasa de Error
```{r}
(584+0)/9866
```
Se observa que se tiene un 5,9% de observaciones mal clasificadas del default del total de clientes testeados.

Sensibilidad
```{r}
1182/1766
```
Se observa que el 67% de los clientes testeados (que eran default) fueron predichos en default de forma correcta.

Especificidad
```{r}
8100/8100
```
Se observa que el 100% de los clientes testeados (no estaban en default) fueron predichos en default de forma correcta.


### Matriz de Confusion en la base de TESTING
Probabilidad > 0,5 como punto de corte
```{r}
tabla_confusion_test = addmargins(table(datos$Default[test],datos$prediccion_default[test] > 0.5))
rownames(tabla_confusion_test) = c("Default NO" ,"Default SI", "TOTAL" )
colnames(tabla_confusion_test)= c("Prediccion Default NO" ,"  Prediccion Default SI" ,"TOTAL" )
tabla_confusion_test
```

### Metricas de la bondad de las predicciones:
Precision
```{r}
(775+5375)/6578
```
Se observa que el 93% de las predicciones de default son clasificadas correctamente respecto al total de clientes testeados.

Tasa de Error
```{r}
(428+0)/6578
```
Se observa que se tiene un 6,5% de observaciones mal clasificadas del default del total de clientes testeados.

Sensibilidad
```{r}
775/1203
```
Se observa que el 64% de los clientes testeados (que eran default) fueron predichos en default de forma correcta.

Especificidad
```{r}
5375/5375
```
Se observa que el 100% de los clientes testeados (no estaban en default) fueron predichos en default de forma correcta.

La matriz de test muestra un patrón muy similar al de train. Este modelo acierta casi todo en “no default” (5375 casos correctos y ningún falso positivo) y mantiene una capacidad moderada para detectar “default” (775 aciertos y 428 errores). Como el desempeño en ambas bases (train y test) es prácticamente consistente, no se observa sobreajuste.

### Utilice el modelo para predecir si un cliente con las siguientes características 
Ingresos del cliente: 45000 dólares anuales   
Crédito disponible: 12000 dólares 
Importe: 12700 dólares 
Sexo: Femenino  
Educación: Secundaria  
Estado civil: Soltero 
Edad: 29 años  
Default: No


Al observar el árbol podado, el mismo siguiendo las reglas de este, se predice que es DEFAULT. Por lo tanto en este caso la prediccion fue erronea.